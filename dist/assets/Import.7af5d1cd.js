import{l as D,j as s,r as S,k as W,d as X,t as Z,m as j,u as Y,v as P,w as L,p as k,E as w}from"./index.b4ce913e.js";import{$ as I,r as ee,t as J,a as le,v as te}from"./validations.f9f88ca6.js";function ne({list:m}){return D(I,{children:[s(I.Head,{children:D(I.Row,{children:[s(I.Cell,{children:"#"}),s(I.Cell,{children:"Row ID"}),s(I.Cell,{children:"Invalid Field"}),s(I.Cell,{children:"Invalid/Duplicate Value"})]})}),s(I.Body,{children:m==null?void 0:m.map((u,v)=>(console.log(u),D(I.Row,{children:[s(I.Cell,{children:v+1}),s(I.Cell,{children:u==null?void 0:u.id}),s(I.Cell,{children:u==null?void 0:u.invalidField}),s(I.Cell,{children:u==null?void 0:u.value})]},v+Math.random())))})]})}function ie(){const[m,u]=S.exports.useState(null),[v,R]=S.exports.useState(0),[H,A]=S.exports.useState(!1),[z,U]=S.exports.useState(""),[_,F]=S.exports.useState(!1),[C,M]=S.exports.useState(Array),[b,N]=S.exports.useState(Array),x=W.useCMA();S.exports.useEffect(()=>{console.log("Updated rowCount-->"+v)},[v]);async function V(e){const n=e==null?void 0:e.split(`
`);let h=[],a;a=n[0].split(",");const i=a[0];let d=[],t=[];d=(await x.contentType.get({contentTypeId:i})).fields,console.log(d),d.forEach(g=>{g.localized&&t.push(g==null?void 0:g.id)}),console.log(t);let f=[];f=(await x.locale.getMany({})).items;const O=ee(n[0].split(","));console.log(O);const y=O.filter((g,E)=>{if(E!=0)return g}).map((g,E)=>"fields."+g).toString().trim();console.log(y);for(var r=2;r<n.length;r++){if(n[r]==null||n[r].trim()=="")continue;var o=n[r].split(",");console.log(o);let g;for(var c=0;c<o.length;c++){const E=a[c];let $={};E!=null&&(t.includes(E)?(console.log("DUPLICATE HEADER--->"+E),f.forEach(q=>{let B=q==null?void 0:q.code;Object.keys($).length===0?($={...$,[B.trim()]:J(o[c])},console.log("initialObject"+JSON.stringify($)),c++):($={...$,[B.trim()]:J(o[c])},console.log("initialObject"+JSON.stringify($)))}),g={...g,[E.trim()]:$},console.log(g)):t.includes(a[c])||(console.log("Not Duplicate "+a[c]),g={...g,[a[c].trim()]:{[w]:J(o[c])}}))}console.dir(g),h.push(g)}console.log(h),Q(h,i,y,t,f)}const G=(e,n,h)=>{const a=[];if(h.forEach((i,d)=>{var t;(t=i==null?void 0:i.validations)==null||t.forEach((l,f)=>{l.hasOwnProperty("unique")&&(l==null?void 0:l.unique)&&a.push(i.id)})}),a.length===0)return!0;{const i=new Set;console.log(a);let d=!0;return a.forEach(t=>(i.clear(),e.concat().forEach(l=>{if(l[t]&&!i.has(l[t][w]))console.error("NOT DUPLICATE ID"),i.add(l[t][w]);else if(l[t])return console.log(l),console.error("DUPLICATE ID ATTRIBUTE -->"+t+" Duplicate ID--->"+l[t][w]),M(f=>[...f,{invalidField:t,id:l[n][w],message:"Duplicate ID found",value:l[t][w]}]),d=!1,d}))),d}},K=(e,n,h,a,i)=>{let d=!0;return e.map(t=>{const l=te(t,h,a,i);console.log(t),l.isValid||(M(f=>[...f,{invalidField:l==null?void 0:l.validationPropertyName,id:t[n][w],message:"Validation failed",value:l==null?void 0:l.value}]),d=!1)}),d};async function Q(e,n,h,a,i){const d=n;let t;const l=await x.contentType.get({contentTypeId:n});t=l.fields,console.log(l.fields),K(e.concat(),n,t,a,i)&&G(e.concat(),n,t)?e.map(f=>{var O;const p=f[n][w];console.log("entryIDx-->"+p),console.log(f),l.fields.length===((O=Object.keys(f))==null?void 0:O.length)?console.log("select string is fine"):console.log("select string is not -fine"),x.entry.getMany({query:{"sys.id":p,content_type:n,limit:1}}).then(T=>{const y=T==null?void 0:T.items[0];console.log(T),delete f[d],console.log(f),console.log(y.fields),le(f,y.fields)?console.log("No Updates required entry ID"+p):(y.fields={...y.fields,...f},console.log("Inside IF"),console.log(y.fields),p===void 0?x.entry.create({contentTypeId:n},y).then(r=>{console.log(r),x.entry.publish({entryId:r.sys.id},r).then(o=>{console.log("cmaEntryPublished"+o),R(c=>c+1)}).catch(o=>{console.log("error while publishing new entry"+p),console.log(o),N(c=>[...c,{...o,title:"Error while publishing new entry"}])})}).catch(r=>{console.log("Error while creating new entry"+p),console.log(r),N(o=>[...o,{...r,title:"Error while creating new entryID"+p}])}):x.entry.update({entryId:p},y).then(r=>{x.entry.publish({entryId:p},r).then(o=>{console.log("cmaEntryPublished"+o),R(c=>c+1)}).catch(o=>{console.log("error while publishing updated old entryID->"+p),console.log(o),N(c=>[...c,{...o,title:"Error while publishing updated entryID"+p}])})}).catch(r=>{console.log("error while updating old entryID->"+p),console.log(r),N(o=>[...o,{...r,title:"Error while updating entryID "+p}])}))})}):(A(!1),u(null),F(!1)),U("Rows affected are "),A(!1),u(null),F(!1)}return D(X,{marginTop:"spacingM",children:[s(Z,{accept:".csv",type:"file",name:"file",onChange:e=>{const h=e.target.files[0];h?(u(h),A(!0),U(""),F(!1)):(u({}),A(!1),U(""),F(!1))}}),s("div",{children:s(j,{startIcon:s(Y,{variant:"muted"}),style:{margin:"10px"},isDisabled:!H,variant:"primary",onClick:()=>{F(!0),R(0),M(n=>[]);const e=m;if(e!=null){const n=new FileReader;n.readAsText(e),n.onload=function(h){var i,d;let a=(d=(i=h==null?void 0:h.target)==null?void 0:i.result)==null?void 0:d.toString();a?V(a):console.error("Error while reading file input")}}},children:_?"Importing":"Import"})}),(b==null?void 0:b.length)===0&&(C==null?void 0:C.length)===0&&z!=""&&s(P,{flexDirection:"column",children:D(L,{title:"File imported successfully",variant:"positive",children:[z,v]})}),(C==null?void 0:C.length)>=1&&s(P,{marginTop:"spacingS",flexDirection:"column",children:D(L,{title:`Validation Errors found in imported cvs file, Rows affected ${v}`,variant:"negative",children:[s(k,{children:"Please find below details for invalid entries"}),s(ne,{list:C})]})}),(b==null?void 0:b.length)>=1&&(b==null?void 0:b.map(e=>s(P,{marginTop:"spacingS",flexDirection:"column",children:D(L,{title:`Run Time Error: ${e==null?void 0:e.title} ,Rows affected ${v}`,variant:"negative",children:[D(k,{children:["Error Code : ",e==null?void 0:e.code]}),D(k,{children:["Message : ",e==null?void 0:e.message]})]})})))]})}export{ie as default};
